environments:
  scratch:
  dev:
  staging:
  production:
---
  
repositories:
  - name: hasura
    url: https://hasura.github.io/helm-charts
  - name: eks
    url: https://aws.github.io/eks-charts
  - name: karpenter
    url: https://charts.karpenter.sh/
  - name: jetstack
    url: https://charts.jetstack.io
  - name: metrics-server
    url: https://kubernetes-sigs.github.io/metrics-server/
  - name: deliveryhero
    url: https://charts.deliveryhero.io/
  - name: snowplow-devops
    url: https://snowplow-devops.github.io/helm-charts
  - name: prometheus
    url: https://prometheus-community.github.io/helm-charts

releases:

  - name: notify-admin
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: admin
      tier: frontend
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/admin.yaml.gotmpl

  - name: notify-api
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: api
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/api.yaml.gotmpl

  - name: notify-celery-beat
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-beat
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-beat.yaml.gotmpl    

  - name: notify-celery-sms
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-sms
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-sms.yaml.gotmpl    

  - name: notify-celery-main-primary
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-main-primary
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-main.yaml.gotmpl   

  - name: notify-celery-main-scalable
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-main-scalable
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-main.yaml.gotmpl   
    - ./overrides/notify/celery-main-hpa.yaml.gotmpl   

  - name: notify-celery-email-send-primary
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-email-send-primary
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-email-send.yaml.gotmpl   

  - name: notify-celery-email-send-scalable
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-email-send-scalable
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-email-send.yaml.gotmpl   
    - ./overrides/notify/celery-email-send-hpa.yaml.gotmpl       

  - name: notify-celery-sms-send-primary
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-sms-send-primary
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-sms-send.yaml.gotmpl   

  - name: notify-celery-sms-send-scalable
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: celery-sms-send-scalable
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/celery-sms-send.yaml.gotmpl   
    - ./overrides/notify/celery-sms-send-hpa.yaml.gotmpl   

  - name: notify-document-download
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: document-download
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/document-download.yaml.gotmpl   

  - name: notify-documentation
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: documentation
      tier: frontend
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/documentation.yaml.gotmpl   

  - name: ipv4-geolocate
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: ipv4-geolocate
      tier: middle
      category: notify
    chart: ./charts/application
    values:
    - ./overrides/notify/ipv4-geolocate.yaml.gotmpl   

  - name: priority-classes
    labels:
      app: priority-classes
      tier: middle
      category: system
    chart: deliveryhero/priority-class
    values:
    - ./overrides/system/priority-classes.yaml.gotmpl

  - name: karpenter
    namespace: karpenter
    wait: true
    labels:
      app: karpenter
      tier: middle
      category: system
    chart: karpenter/karpenter
    version: 0.16.3
    values:
    - ./overrides/system/karpenter.yaml.gotmpl
    hooks:
      - events:
        - cleanup
        showlogs: true
        command: kubectl
        args:
        - apply
        - -f
        - "./overrides/system/karpenter-provisioner.yaml"    

  - name: cloudwatch-agent
    namespace: amazon-cloudwatch
    labels:
      app: cloudwatch-agent
      tier: middle
      category: monitoring
    chart: ./charts/aws-cloudwatch-metrics
    values:
    - ./overrides/system/cloudwatch-agent.yaml.gotmpl

  - name: fluentbit
    namespace: amazon-cloudwatch
    labels:
      app: fluentbit
      tier: middle
      category: monitoring
    chart: ./charts/aws-for-fluent-bit
    values:
    - ./overrides/system/fluentbit.yaml.gotmpl


  - name: metrics-server
    namespace: kube-system
    labels:
      app: metrics-server
      tier: middle
      category: monitoring
    chart: metrics-server/metrics-server

  - name: prometheus
    namespace: amazon-cloudwatch
    labels:
      app: prometheus
      tier: full
      category: monitoring
    chart: prometheus/prometheus
    values:
    - ./overrides/system/prometheus.yaml.gotmpl

  - name: k8s-event-logger
    namespace: amazon-cloudwatch
    labels:
      app: k8s-event-logger
      tier: middle
      category: monitoring
    chart: deliveryhero/k8s-event-logger

  - name: cert-manager
    namespace: cert-manager
    labels:
      app: cert-manager
      tier: middle
      category: system
    chart: jetstack/cert-manager
    values:
    - ./overrides/system/cert-manager.yaml.gotmpl
    hooks:
      - events:
        - prepare
        showlogs: true
        command: kubectl
        args:
        - apply
        - -f
        - "https://github.com/cert-manager/cert-manager/releases/download/v1.12.7/cert-manager.crds.yaml"


  - name: aws-load-balancer-controller
    namespace: kube-system
    labels:
      app: aws-alb-controller
      tier: middle
      category: system
    chart: eks/aws-load-balancer-controller
    values:
    - ./overrides/system/aws-alb-controller.yaml.gotmpl
    hooks:
    - events:
      - prepare
      showlogs: true
      command: kubectl
      args:
      - apply
      - -k
      - https://github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master

  - name: hasura
    namespace: notify-{{ .Environment.Name }}
    labels:
      app: hasura
      tier: frontend
      category: utils
    chart: hasura/graphql-engine
    values:
    - ./overrides/utils/hasura.yaml.gotmpl