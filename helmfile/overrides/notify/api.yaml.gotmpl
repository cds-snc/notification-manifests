readinessProbe:
  httpGet:
    path: /_status?simple=true
    port: 6011
  initialDelaySeconds: 10
  periodSeconds: 3
  timeoutSeconds: 1
  successThreshold: 3
  failureThreshold: 10
livenessProbe:
  httpGet:
    path: "/_status?simple=true"
    port: 6011
  initialDelaySeconds: 30
  periodSeconds: 3
  timeoutSeconds: 1
  successThreshold: 1
  failureThreshold: 3

serviceAccount:
  create: true
  serviceAccountName: "notify-api"
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::{{ requiredEnv "AWS_ACCOUNT_ID" }}:role/secrets-csi-role-notify-api

image: 
  repository: public.ecr.aws/cds-snc/notify-api
  tag: 7c19d9f
  pullPolicy: Always

initContainers:
  - name: init-postgres
    image: alpine
    command:
      [
        "sh",
        "-c",
        "until nslookup {{ requiredEnv "POSTGRES_HOST" }}; do echo waiting for postgres; sleep 2; done;",
      ]
  - name: migrate-db
    image: api
    volumeMounts:
      - name: secrets-store-inline
        mountPath: "/mnt/secrets-store"
        readOnly: true   
    env:
      - name: ADMIN_BASE_URL
        value: https://{{ requiredEnv "BASE_DOMAIN" }}
      - name: ADMIN_CLIENT_SECRET
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: ADMIN_CLIENT_SECRET
      - name: ALLOW_DEBUG_ROUTE
        {{ if eq .Environment.Name "production" }}
        value: "false"
        {{ else }}
        value: "true"
        {{ end }}       
      - name: ASSET_UPLOAD_BUCKET_NAME
        value: notification-canada-ca-{{.Environment.Name}}-asset-upload
      - name: ASSET_DOMAIN
        {{ if eq .Environment.Name "production" }}
        value: https:/assets.notification.canada.ca
        {{ else }}
        value: https://assets.{{ .Environment.Name }}.notification.cdssandbox.xyz
        {{ end }}  
      - name: AWS_ROUTE53_ZONE
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_ROUTE53_ZONE
      - name: AWS_SES_REGION
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_SES_REGION
      - name: AWS_SES_SMTP
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_SES_SMTP
      - name: AWS_SES_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_SES_ACCESS_KEY
      - name: AWS_SES_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_SES_SECRET_KEY
      - name: BATCH_INSERTION_CHUNK_SIZE
        value: '10'
      - name: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
      - name: CRM_ORG_LIST_URL
        value: https://raw.githubusercontent.com/cds-snc/gc-organisations/main/data/all.json
      - name: CSV_UPLOAD_BUCKET_NAME
        value: notification-canada-ca-{{.Environment.Name}}-csv-upload
      {{ if not (eq .Environment.Name "production") }}
      - name: DEBUG_KEY
        valueFrom:
          secretKeyRef:
          name: notify-api
            key: DEBUG_KEY
      {{ end }}
      - name: DANGEROUS_SALT
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: DANGEROUS_SALT
      - name: DOCUMENT_DOWNLOAD_API_HOST
        value: 'http://document-download-api.{{.Release.Namespace}}.svc.cluster.local:7000'
      - name: DOCUMENTATION_DOMAIN
        value: 'documentation.{{ requiredEnv "BASE_DOMAIN" }}'
      - name: FF_SALESFORCE_CONTACT
        value: "true"
      - name: FF_SPIKE_SMS_DAILY_LIMIT
        value: "true"
      - name: FF_SMS_PARTS_UI
        value: "false"
      - name: FIDO2_DOMAIN
        value: {{ requiredEnv "BASE_DOMAIN" }}
      - name: FLASK_APP
        value: application.py
      - name: NOTIFY_EMAIL_DOMAIN
        value: {{ requiredEnv "BASE_DOMAIN" }}
      - name: NOTIFY_ENVIRONMENT
        value: {{.Environment.Name}}
      - name: NOTIFICATION_QUEUE_PREFIX
        value: "eks-notification-canada-ca"
      - name: REDIS_URL
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: REDIS_URL
      - name: REDIS_PUBLISH_URL
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: REDIS_PUBLISH_URL
      - name: REDIS_ENABLED
        value: "1"
      - name: SALESFORCE_DOMAIN
        value: "login"
      - name: SALESFORCE_ENGAGEMENT_PRODUCT_ID
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_ENGAGEMENT_PRODUCT_ID
      - name: SALESFORCE_ENGAGEMENT_RECORD_TYPE
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_ENGAGEMENT_RECORD_TYPE
      - name: SALESFORCE_ENGAGEMENT_STANDARD_PRICEBOOK_ID
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_ENGAGEMENT_STANDARD_PRICEBOOK_ID
      - name: SALESFORCE_GENERIC_ACCOUNT_ID
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_GENERIC_ACCOUNT_ID                      
      - name: SALESFORCE_PASSWORD
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_PASSWORD   
      - name: SALESFORCE_SECURITY_TOKEN
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_SECURITY_TOKEN   
      - name: SALESFORCE_USERNAME
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SALESFORCE_USERNAME                 
      - name: SECRET_KEY
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SECRET_KEY
      - name: SENDGRID_API_KEY
        valueFrom:
            secretKeyRef:
              name: notify-api
              key: SENDGRID_API_KEY
      - name: SQLALCHEMY_DATABASE_URI
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: SQLALCHEMY_DATABASE_URI
      - name: STATSD_HOST
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: TWILIO_ACCOUNT_SID
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: TWILIO_ACCOUNT_SID
      - name: TWILIO_AUTH_TOKEN
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: TWILIO_AUTH_TOKEN
      - name: TWILIO_FROM_NUMBER
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: TWILIO_FROM_NUMBER
      - name: AWS_US_TOLL_FREE_NUMBER
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: AWS_US_TOLL_FREE_NUMBER
      - name: NEW_RELIC_MONITOR_MODE
        value: "true"
      - name: ZENDESK_SELL_API_URL
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: ZENDESK_SELL_API_URL
      - name: ZENDESK_SELL_API_KEY
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: ZENDESK_SELL_API_KEY
      - name: ZENDESK_API_URL
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: ZENDESK_API_URL
      - name: ZENDESK_API_KEY
        valueFrom:
          secretKeyRef:
            name: notify-api
            key: ZENDESK_API_KEY

    command:
      [
        "sh",
        "-c",
        "flask db upgrade",
      ]

env:
  - name: ADMIN_BASE_URL
    value: https://{{ requiredEnv "BASE_DOMAIN" }}
  - name: ADMIN_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ADMIN_CLIENT_SECRET
  - name: ALLOW_HTML_SERVICE_IDS
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ALLOW_HTML_SERVICE_IDS        
  - name: API_HOST_NAME
    {{ if eq .Environment.Name "dev" }}
      value: https://api-k8s.notification.canada.ca
    {{ else }}
      {{ if eq .Environment.Name "production" }}
      value: https://notification.canada.ca
      {{ else }}
      value: https://{{ .Environment.Name }}.notification.cdssandbox.xyz
      {{ end }}  
    {{ end }}
  - name: ASSET_UPLOAD_BUCKET_NAME
    value: notification-canada-ca-{{.Environment.Name}}-asset-upload
  - name: ASSET_DOMAIN
    {{ if eq .Environment.Name "production" }}
    value: https:/assets.notification.canada.ca
    {{ else }}
    value: https://assets.{{ .Environment.Name }}.notification.cdssandbox.xyz
    {{ end }}  
  - name: AWS_PINPOINT_REGION
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_PINPOINT_REGION
  - name: AWS_REGION
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_REGION
  - name: AWS_ROUTE53_ZONE
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_ROUTE53_ZONE
  - name: AWS_SES_REGION
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_SES_REGION
  - name: AWS_SES_SMTP
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_SES_SMTP
  - name: AWS_SES_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_SES_ACCESS_KEY
  - name: AWS_SES_SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_SES_SECRET_KEY
  - name: BATCH_INSERTION_CHUNK_SIZE
    value: '10'
  - name: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
  - name: CRM_ORG_LIST_URL
    value: https://raw.githubusercontent.com/cds-snc/gc-organisations/main/data/all.json
  - name: CSV_UPLOAD_BUCKET_NAME
    value: notification-canada-ca-{{.Environment.Name}}-csv-upload
  - name: DANGEROUS_SALT
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: DANGEROUS_SALT
  - name: DOCUMENT_DOWNLOAD_API_HOST
    value: 'http://document-download-api.{{.Release.Namespace}}.svc.cluster.local:7000'
  - name: FF_SALESFORCE_CONTACT
    value: "true"
  - name: FF_SPIKE_SMS_DAILY_LIMIT
    value: "true"
  - name: FIDO2_DOMAIN
    value: {{ requiredEnv "BASE_DOMAIN" }}
  - name: NOTIFY_EMAIL_DOMAIN
    value: {{ requiredEnv "BASE_DOMAIN" }}
  - name: FRESH_DESK_API_URL
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: FRESH_DESK_API_URL
  - name: FRESH_DESK_API_KEY
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: FRESH_DESK_API_KEY
  - name: FRESH_DESK_PRODUCT_ID
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: FRESH_DESK_PRODUCT_ID
  - name: HC_EN_SERVICE_ID
    valueFrom:
      secretKeyRef:
        name: notify-admin
        key: HC_EN_SERVICE_ID
  - name: HC_FR_SERVICE_ID
    valueFrom:
      secretKeyRef:
        name: notify-admin
        key: HC_FR_SERVICE_ID
  - name: NOTIFY_ENVIRONMENT
    value: {{.Environment.Name}}
  - name: NOTIFICATION_QUEUE_PREFIX
    value: "eks-notification-canada-ca"
  - name: REDIS_URL
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: REDIS_URL
  - name: REDIS_PUBLISH_URL
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: REDIS_PUBLISH_URL
  - name: REDIS_ENABLED
    value: "1"
  - name: SALESFORCE_DOMAIN
    value: "login"
  - name: SALESFORCE_ENGAGEMENT_PRODUCT_ID
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_ENGAGEMENT_PRODUCT_ID
  - name: SALESFORCE_ENGAGEMENT_RECORD_TYPE
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_ENGAGEMENT_RECORD_TYPE
  - name: SALESFORCE_ENGAGEMENT_STANDARD_PRICEBOOK_ID
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_ENGAGEMENT_STANDARD_PRICEBOOK_ID
  - name: SALESFORCE_GENERIC_ACCOUNT_ID
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_GENERIC_ACCOUNT_ID                      
  - name: SALESFORCE_PASSWORD
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_PASSWORD   
  - name: SALESFORCE_SECURITY_TOKEN
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_SECURITY_TOKEN   
  - name: SALESFORCE_USERNAME
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SALESFORCE_USERNAME                 
  - name: SECRET_KEY
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SECRET_KEY
  - name: SENDGRID_API_KEY
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SENDGRID_API_KEY
  - name: SQLALCHEMY_DATABASE_URI
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: SQLALCHEMY_DATABASE_URI
  - name: SQLALCHEMY_DATABASE_READER_URI
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: SQLALCHEMY_DATABASE_READER_URI
  - name: SQLALCHEMY_POOL_SIZE
    value: "256"
  - name: STATSD_HOST
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  - name: SRE_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: SRE_CLIENT_SECRET
  - name: TWILIO_ACCOUNT_SID
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: TWILIO_ACCOUNT_SID
  - name: TWILIO_AUTH_TOKEN
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: TWILIO_AUTH_TOKEN
  - name: TWILIO_FROM_NUMBER
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: TWILIO_FROM_NUMBER
  - name: AWS_US_TOLL_FREE_NUMBER
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: AWS_US_TOLL_FREE_NUMBER
  - name: SENTRY_URL
    valueFrom:
        secretKeyRef:
          name: notify-api
          key: SENTRY_URL
  - name: NEW_RELIC_APP_NAME
    value: notification-api-{{ .Environment.Name }}
  - name: NEW_RELIC_DISTRIBUTED_TRACING_ENABLED
    value: "true"
  - name: NEW_RELIC_LICENSE_KEY
    valueFrom:
        secretKeyRef:
          name: notify-admin
          key: NEW_RELIC_LICENSE_KEY
  - name: NEW_RELIC_MONITOR_MODE
    value: "true"
  - name: ZENDESK_SELL_API_URL
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ZENDESK_SELL_API_URL
  - name: ZENDESK_SELL_API_KEY
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ZENDESK_SELL_API_KEY
  - name: ZENDESK_API_URL
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ZENDESK_API_URL
  - name: ZENDESK_API_KEY
    valueFrom:
      secretKeyRef:
        name: notify-api
        key: ZENDESK_API_KEY
  - name: FF_CLOUDWATCH_METRICS_ENABLED
    value: "true"
  - name: FF_BOUNCE_RATE_V1
    value: "false"
  - name: FF_BOUNCE_RATE_BACKEND
    value: "false"



secretProviderClass:
  enabled: true
  provider: aws
  #This is the source names from AWS Secrets Manager
  parameters:
    objects: |
      - objectName: ADMIN_CLIENT_SECRET
        objectType: "secretsmanager"
      - objectName: ALLOW_HTML_SERVICE_IDS
        objectType: "secretsmanager"
      - objectName: BULK_SEND_TEST_SERVICE_ID
        objectType: "secretsmanager"
      - objectName: DANGEROUS_SALT
        objectType: "secretsmanager"
      - objectName: HC_EN_SERVICE_ID
        objectType: "secretsmanager"
      - objectName: HC_FR_SERVICE_ID
        objectType: "secretsmanager"
      - objectName: MIXPANEL_PROJECT_TOKEN
        objectType: "secretsmanager"
      - objectName: SENSITIVE_SERVICES
        objectType: "secretsmanager"        
      - objectName: REDIS_URL
        objectType: "secretsmanager"
      - objectName: REDIS_PUBLISH_URL
        objectType: "secretsmanager"
      - objectName: SECRET_KEY
        objectType: "secretsmanager"
      - objectName: SENTRY_URL
        objectType: "secretsmanager"
      - objectName: NEW_RELIC_LICENSE_KEY
        objectType: "secretsmanager"
      - objectName: GC_ARTICLES_API_AUTH_USERNAME
        objectType: "secretsmanager"
      - objectName: GC_ARTICLES_API_AUTH_PASSWORD
        objectType: "secretsmanager"
      - objectName: WAF_SECRET
        objectType: "secretsmanager"      
      - objectName: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
        objectType: "secretsmanager"
      - objectName: FF_ABTEST_SERVICE_ID
        objectType: "secretsmanager"          
      - objectName: SQLALCHEMY_DATABASE_URI
        objectType: "secretsmanager"                
  #This is the target name in the kubernetes secret      
  secretObjects:
    - data:
      - key: ADMIN_CLIENT_SECRET
        objectName: ADMIN_CLIENT_SECRET
      - key: ALLOW_HTML_SERVICE_IDS
        objectName: ALLOW_HTML_SERVICE_IDS
      - key: BULK_SEND_TEST_SERVICE_ID
        objectName: BULK_SEND_TEST_SERVICE_ID
      - key: DANGEROUS_SALT
        objectName: DANGEROUS_SALT
      - key: HC_EN_SERVICE_ID
        objectName: HC_EN_SERVICE_ID
      - key: HC_FR_SERVICE_ID
        objectName: HC_FR_SERVICE_ID
      - key: MIXPANEL_PROJECT_TOKEN
        objectName: MIXPANEL_PROJECT_TOKEN
      - key: SENSITIVE_SERVICES
        objectName: SENSITIVE_SERVICES
      - key: REDIS_URL
        objectName: REDIS_URL
      - key: REDIS_PUBLISH_URL
        objectName: REDIS_PUBLISH_URL
      - key: SECRET_KEY
        objectName: SECRET_KEY
      - key: SENTRY_URL
        objectName: SENTRY_URL
      - key: NEW_RELIC_LICENSE_KEY
        objectName: NEW_RELIC_LICENSE_KEY
      - key: GC_ARTICLES_API_AUTH_USERNAME
        objectName: GC_ARTICLES_API_AUTH_USERNAME
      - key: GC_ARTICLES_API_AUTH_PASSWORD
        objectName: GC_ARTICLES_API_AUTH_PASSWORD
      - key: WAF_SECRET
        objectName: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
      - key: CRM_GITHUB_PERSONAL_ACCESS_TOKEN
        objectName: GC_ARTICLES_API_AUTH_PASSWORD
      - key: FF_ABTEST_SERVICE_ID
        objectName: FF_ABTEST_SERVICE_ID        
      - key: SQLALCHEMY_DATABASE_URI
        objectName: SQLALCHEMY_DATABASE_URI           

      secretName: notify-admin
      type: generic
