name: Test manifest build
description: Test if a Kustomize manifest build works
inputs:
  build-target:
    description: Name of the manifest build target
    required: true

runs:
  using: "composite"
  steps:
    - name: Test manifest build
      shell: bash
      run: |
        exec 5>&1        
        MANIFEST="$(make ${{ inputs.build-target }} | tee /dev/fd/5)"
        EXIT=0

        if echo "$MANIFEST" | grep 'value: $('
        then
          echo "❌ Undefined environment variable found"
          EXIT=1
        fi

        if echo "$MANIFEST" | grep 'well-defined vars that were never replaced'
        then
          echo "❌ Unreplaced environment variable found"
          EXIT=1
        fi

        exit $EXIT
